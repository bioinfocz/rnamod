#!/usr/bin/env python3

import os

import argparse
import rnamod.mod as mod
import rnamod.config as config
import rnamod.utils as utils

try:
   from IPython import embed as repl
except NameError:
   pass

parser = argparse.ArgumentParser(description='Find RNA modifications')

parser.add_argument('--experiments', action='append',
                                     nargs='+',
                                     required=True)
parser.add_argument('--checks', action='append',
                                nargs='+',
                                required=True)
parser.add_argument('--fasta', action='append',
                               nargs='+',
                               required=True)
parser.add_argument('--pattern', action='append',
                                 nargs='+')
parser.add_argument('--min-coverage', default=config.min_coverage,
                                      type=int)
parser.add_argument('--max-pvalue', default=config.max_pvalue,
                                    type=float)
parser.add_argument('--min-stops-relative', default=config.min_stops_relative,
                                            type=float)
parser.add_argument('--min-errors-relative', default=config.min_errors_relative,
                                             type=float)
parser.add_argument('--no-html', action='store_true')
parser.add_argument('--no-tsv', action='store_true')
parser.add_argument('--outputs')

args = parser.parse_args()

config.min_coverage = args.min_coverage
config.max_pvalue = args.max_pvalue
config.min_stops_relative = args.min_stops_relative
config.min_errors_relative = args.min_errors_relative

print('Experiments:')
for file in utils.flatten(args.experiments):
   print('  - {}'.format(file))

print('Checks:')
for file in utils.flatten(args.checks):
   print('  - {}'.format(file))

print('Fasta:')
for file in utils.flatten(args.fasta):
   print('  - {}'.format(file))

print('Pattern:')
for pattern in utils.flatten(args.pattern):
   print('  - {}'.format(pattern))

print('Min coverage: {}'.format(config.min_coverage))
print('Max p-value: {}'.format(config.max_pvalue))
print('Min relative stops: {}'.format(config.min_stops_relative))
print('Min relative errors: {}'.format(config.min_errors_relative))
print('')

rmod = mod.Mod(args.fasta, args.pattern)
rmod.run(args.experiments, args.checks)

outputs = args.outputs
if outputs:
   if not os.path.isdir(outputs):
      print('Path {} is not a directory'.format(outputs))
      exit(1)
else:
   outputs = utils.ensure_directory('outputs')

if not args.no_html:
   rmod.to_html(outputs)

if not args.no_tsv:
   rmod.to_tsv(outputs)

print('')
print('Outputs are stored in "{}"'.format(outputs))

